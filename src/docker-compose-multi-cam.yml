#
# Copyright (C) 2025 Intel Corporation.
#
# SPDX-License-Identifier: Apache-2.0
#

 ## Current Developer Toolbox doesn't support environment files, make sure to remove any files or environment variables starting with $
services:
  camera-simulator:
    container_name: camera-simulator
    image: aler9/rtsp-simple-server
    ports:
      - "127.0.0.1:8554:8554"
  # camera-simulator0:
  #   image: jrottenberg/ffmpeg:4.1-alpine
  #   container_name: camera-simulator0
  #   network_mode: "host"
  #   entrypoint: ["/bin/sh","-c"]
  #   command: 
  #   - | 
  #      if [ ! -f /home/pipeline-server/sample-media/lp_cam4.mp4 ]; then
  #         mkdir -p /home/pipeline-server/sample-media
  #         wget -O /home/pipeline-server/sample-media/lp_cam4.mp4 https://github.com/ejlee3/sample-clips/raw/refs/heads/main/lp_cam4.mp4
  #         wget -O /home/pipeline-server/sample-media/lp_cam10.mp4 https://github.com/ejlee3/sample-clips/raw/refs/heads/main/lp_cam10.mp4
  #         wget -O /home/pipeline-server/sample-media/lp_cam16.mp4 https://github.com/ejlee3/sample-clips/raw/refs/heads/main/lp_cam16.mp4
  #      fi
  #      ffmpeg -nostdin -re -stream_loop -1 -i /home/pipeline-server/sample-media/lp_cam4_cov.mp4 \
  #      -map 0 -c copy -f rtsp -rtsp_transport tcp rtsp://localhost:8554/camera_0 
  #      -nostdin -re -stream_loop -1 -i /home/pipeline-server/sample-media/lp_cam10.mp4 \
  #      -map 1 -c copy -f rtsp -rtsp_transport tcp rtsp://localhost:8554/camera_1 \
  #      -nostdin -re -stream_loop -1 -i /home/pipeline-server/sample-media/lp_cam16.mp4 \
  #      -map 2 -c copy -f rtsp -rtsp_transport tcp rtsp://localhost:8554/camera_2
  #   depends_on:
  #     - camera-simulator
  #   volumes:
  #     - ${RETAIL_USE_CASE_ROOT:-..}/performance-tools/sample-media:/home/pipeline-server/sample-media
  camera-simulator1:
    image: jrottenberg/ffmpeg:4.1-alpine
    container_name: camera-simulator1
    network_mode: "host"
    entrypoint: ["/bin/sh","-c"]
    command: 
    - | 
       if [ ! -f /home/pipeline-server/sample-media/coca-cola-4465029-1920-15-bench.mp4 ]; then
          mkdir -p /home/pipeline-server/sample-media
          wget -O /home/pipeline-server/sample-media/coca-cola-4465029-1920-15-bench.mp4 https://www.pexels.com/download/video/4465029
       fi
       ffmpeg -nostdin -re -stream_loop -1 -i /home/pipeline-server/sample-media/coca-cola-4465029-1920-15-bench.mp4 \
       -c copy -f rtsp -rtsp_transport tcp rtsp://localhost:8554/camera_3 \
       -c copy -f rtsp -rtsp_transport tcp rtsp://localhost:8554/camera_4 \
       -c copy -f rtsp -rtsp_transport tcp rtsp://localhost:8554/camera_5
    depends_on:
      - camera-simulator
    volumes:
      - ${RETAIL_USE_CASE_ROOT:-..}/performance-tools/sample-media:/home/pipeline-server/sample-media
  OvmsMultiClientGst:
    image: dlstreamer:dev
    deploy:
      mode: replicated
      replicas: ${PIPELINE_COUNT:-1}
    network_mode: "host"
    entrypoint: /script/entrypoint_multistream.sh
    privileged: true
    ipc: "host"
    env_file:
      - ./res/gst.env
      - ${DEVICE_ENV:-res/all-cpu.env}
    environment:
      - CONTAINER_NAME="gst0"
      - INPUTSRC=${INPUTSRC:-rtsp://localhost:8554/camera_0}
      - RENDER_MODE=${RENDER_MODE:-0} #RENDER_MODE=1 will work only after running xhost +local:docker      
      - RTSP=${RTSP:-0}
      - DISPLAY=$DISPLAY
      - HTTP_PROXY
      - HTTPS_PROXY
      - NO_PROXY
      - INPUT_VIDEO_FILE_1=rtsp://localhost:8554/camera_3
      - INPUT_VIDEO_FILE_2=rtsp://localhost:8554/camera_4
      - INPUT_VIDEO_FILE_3=rtsp://localhost:8554/camera_5
    volumes:
      - ${RESULTS_DIR:-../results}:/tmp/results
      - ~/.Xauthority:/home/dlstreamer/.Xauthority
      - /tmp/.X11-unix
      - ~/.cl-cache:/home/pipeline-server/.cl-cache
      - ./res/:/home/pipeline-server/envs
      - ${RETAIL_USE_CASE_ROOT:-..}/models:/home/pipeline-server/models
      - ./pipelines/:/home/pipeline-server/pipelines
      - ./extensions/:/home/pipeline-server/extensions
      - ./entrypoint_multistream.sh:/script/entrypoint_multistream.sh
    depends_on:
      - camera-simulator

  mosquitto:
    image: eclipse-mosquitto:2.0    
    network_mode: "host"
    ports:
      - "127.0.0.1:1883:1883"
    depends_on:
      - OvmsMultiClientGst    
  